name: CMEMS model workflow2

on:
  # triggered on push to repo
  # push:
  #   branches: main
  # triggered by cron job
  # schedule:
    # * is a special character in YAML so you have to quote this string
    # https://crontab.cronhub.io
    # - cron:  '30 15 * * *'  #scheduled to run at 3:30 pm UTC every day
  # triggered by manual activation on GitHub repo website
  workflow_dispatch:

jobs:
  download_cmems:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    concurrency:
      group: ${{ github.workflow }}-data-push
      cancel-in-progress: true
    steps:
    - name: Check out repository
      uses: actions/checkout@v4
      # with:
      #   fetch-depth: 0 # fetch all commits/branches
      with:
        sparse-checkout: |
          metadata/
          data_acquisition/R/
          # data_acquisition/netcdfs/cmems_ncdfs/
        sparse-checkout-cone-mode: false # Set to false for more granular control
    
    - name: Create empty dir for NCDF files
      run: mkdir -p data_acquisition/netcdfs/cmems_ncdfs

    - name: Install Conda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: 3.11

    # - name: Check disk space
    #   run: |
    #     df -h
    #     du -sh ~/

    - name: Install Copernicus Marine Toolbox
      shell: bash -el {0}
      run: |
        conda install -c conda-forge copernicusmarine
        conda install scipy

    - name: Install R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.4.3'

    - name: Install R packages
      uses: r-lib/actions/setup-r-dependencies@v2
      with:
        cache-version: 4

    - name: Download CMEMS data
      env:
        COPERNICUSMARINE_SERVICE_USERNAME: ${{ secrets.COPERNICUSMARINE_SERVICE_USERNAME }}
        COPERNICUSMARINE_SERVICE_PASSWORD: ${{ secrets.COPERNICUSMARINE_SERVICE_PASSWORD }}
      shell: Rscript {0}
      run: |
        source("data_acquisition/R/acquire_cmems.R")
      working-directory: ${{ github.workspace }}
    
    - name: ðŸš€ Push multiple files via GitHub API
      env:
        # Use your PAT secret here for authentication
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # --- Configuration ---
        TARGET_ORG="joshcullen"
        TARGET_REPO="CEG_operationalization_data"
        TARGET_BRANCH="main"
        SOURCE_DIR="data_acquisition/netcdfs/cmems_ncdfs" # The local directory to scan
        TARGET_DIR="CMEMS" # The destination directory in the repo
        COMMIT_MESSAGE="Added multiple CMEMS NCDF files via API for commit ${{ github.sha }}"
        
        # --- 1. Programmatically Create a Blob for Each File & Build Tree JSON ---
        echo "STEP 1: Creating blobs and building tree..."
        
        # This structure captures the final tree JSON from the loop, avoiding the subshell issue.
        TREE_JSON_PAYLOAD=$(find "$SOURCE_DIR" -type f -name "*.nc" | while read -r filepath; do
          echo "Processing file: $filepath" >&2
          filename=$(basename "$filepath")
          
          # âœ… FIX 1: Pipe the JSON payload into curl instead of passing as an argument.
          # The `-d @-` tells curl to read from standard input.
          CONTENT_BASE64=$(base64 -w 0 "$filepath")
          BLOB_SHA=$(printf '{"content":"%s", "encoding":"base64"}' "$CONTENT_BASE64" | \
            curl -s -L \
              -X POST -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GH_TOKEN" \
              "https://api.github.com/repos/${TARGET_ORG}/${TARGET_REPO}/git/blobs" \
              -d @- | \
            jq -r '.sha')
          
          if [ "$BLOB_SHA" = "null" ] || [ -z "$BLOB_SHA" ]; then echo "Error: Failed to create blob for $filename"; exit 1; fi
          echo "  - Blob created with SHA: $BLOB_SHA" >&2
          
          # âœ… FIX 2: Echo the JSON for this file so it can be captured by TREE_JSON_PAYLOAD
          printf '{"path":"%s/%s","mode":"100644","type":"blob","sha":"%s"},' \
            "$TARGET_DIR" "$filename" "$BLOB_SHA"
        done)
        if [ -z "$TREE_JSON_PAYLOAD" ]; then
          echo "No files were processed successfully."
          exit 1
        fi
        
        TREE_JSON_PAYLOAD="[${TREE_JSON_PAYLOAD%?}]"
        
        # --- 2. Get the Parent Commit SHA ---
        echo "STEP 2: Getting parent commit..."
        PARENT_SHA=$(curl -s -L \
          -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GH_TOKEN" \
          "https://api.github.com/repos/${TARGET_ORG}/${TARGET_REPO}/git/ref/heads/${TARGET_BRANCH}" \
          | jq -r '.object.sha')
        if [ "$PARENT_SHA" = "null" ]; then echo "Error: Failed to get parent SHA"; exit 1; fi
        echo "Parent commit SHA: $PARENT_SHA"
        
        # --- 3. Create a single Tree with all files ---
        echo "STEP 3: Creating tree..."
        FINAL_TREE_JSON=$(printf '{"base_tree":"%s","tree":%s}' "$PARENT_SHA" "$TREE_JSON_PAYLOAD")
        
        TREE_SHA=$(echo "$FINAL_TREE_JSON" | curl -s -L \
          -X POST -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GH_TOKEN" \
          "https://api.github.com/repos/${TARGET_ORG}/${TARGET_REPO}/git/trees" \
          -d @- | jq -r '.sha')
        if [ "$TREE_SHA" = "null" ]; then echo "Error: Failed to create tree"; exit 1; fi
        echo "Tree created with SHA: $TREE_SHA"
        
        # --- 4. Create a Commit & 5. Update the Branch Reference (Unchanged) ---
        COMMIT_JSON=$(printf '{"message":"%s","parents":["%s"],"tree":"%s"}' "$COMMIT_MESSAGE" "$PARENT_SHA" "$TREE_SHA")
        
        COMMIT_SHA=$(curl -s -L -X POST -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GH_TOKEN" "https://api.github.com/repos/${TARGET_ORG}/${TARGET_REPO}/git/commits" -d "$COMMIT_JSON" | jq -r '.sha')
        if [ "$COMMIT_SHA" = "null" ]; then echo "Error: Failed to create commit"; exit 1; fi
        echo "Commit created with SHA: $COMMIT_SHA"
        REF_JSON=$(printf '{"sha":"%s"}' "$COMMIT_SHA")
        curl -s -L -X PATCH -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GH_TOKEN" "https://api.github.com/repos/${TARGET_ORG}/${TARGET_REPO}/git/refs/heads/${TARGET_BRANCH}" -d "$REF_JSON"

        echo "âœ… Branch update complete!"