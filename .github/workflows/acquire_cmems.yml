name: Download CMEMS data

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  acquire-cmems:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
    # --- [NEW STEP] FREE UP DISK SPACE ---
    # This deletes Android SDKs, .NET, and Haskell to make room for your data
    - name: Free Disk Space (Ubuntu)
      run: |
        echo "Disk space before cleanup:"
        df -h
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        echo "Disk space after cleanup:"
        df -h

    - name: Check out repository
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          metadata/
          data_acquisition/R/
          data_acquisition/netcdfs/cmems_ncdfs/
        sparse-checkout-cone-mode: false

    - name: Install Conda & Capture Tool Path
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: 3.11
        activate-environment: test
        # Add this to clean up conda cache and save more space
        clean-patched-environment-file: true 

    - name: Install Copernicus Marine Toolbox
      shell: bash -el {0}
      run: |
        conda install -c conda-forge copernicusmarine scipy
        # Clean conda cache to save space
        conda clean --all --yes
        
        # Capture Path
        TOOL_PATH=$(which copernicusmarine)
        echo "Found copernicusmarine at: $TOOL_PATH"
        echo "CM_TOOL_PATH=$TOOL_PATH" >> $GITHUB_ENV

    - name: Install R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3.3'

    - name: Install R packages
      uses: r-lib/actions/setup-r-dependencies@v2
      with:
        cache-version: 4

    - name: Download CMEMS data
      env:
        COPERNICUSMARINE_SERVICE_USERNAME: ${{ secrets.COPERNICUSMARINE_SERVICE_USERNAME }}
        COPERNICUSMARINE_SERVICE_PASSWORD: ${{ secrets.COPERNICUSMARINE_SERVICE_PASSWORD }}
      shell: Rscript {0}
      run: |
        source("data_acquisition/R/acquire_cmems.R")
      working-directory: ${{ github.workspace }}

    - name: Commit and Push Changes
      run: |
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"

        git add .
        
        # Check if there are changes before committing
        if git diff --staged --quiet; then
          echo "No changes to commit."
        else
          git commit -m "Added new CMEMS file"
          git pull origin main --rebase
          git push origin main
        fi
