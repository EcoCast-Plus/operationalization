name: Download CMEMS data

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  acquire-cmems:
    runs-on: ubuntu-22.04 # 22.04 is stable and fast for R
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      COPERNICUSMARINE_SERVICE_USERNAME: ${{ secrets.COPERNICUSMARINE_SERVICE_USERNAME }}
      COPERNICUSMARINE_SERVICE_PASSWORD: ${{ secrets.COPERNICUSMARINE_SERVICE_PASSWORD }}
    steps:
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc

    - name: Check out repository
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          metadata/
          data_acquisition/R/
          data_acquisition/netcdfs/cmems_ncdfs/
        sparse-checkout-cone-mode: false

    - name: Install Conda & Capture Tool Path
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: 3.11
        activate-environment: test

    - name: Install Copernicus Tool
      shell: bash -el {0}
      run: |
        conda install -c conda-forge copernicusmarine scipy
        # Capture Path for R
        TOOL_PATH=$(which copernicusmarine)
        echo "CM_TOOL_PATH=$TOOL_PATH" >> $GITHUB_ENV

    - name: Install R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.4.3'

    # [CRITICAL FIX] Install ONLY what is needed for downloading
    - name: Install R Dependencies
      uses: r-lib/actions/setup-r-dependencies@v2
      with:
        cache: always
        # Force a new cache key just in case
        cache-version: 2
        packages: |
          any::dplyr
          any::readr
          any::purrr
          any::glue
          any::lubridate

    - name: Run Download Script
      shell: Rscript {0}
      run: source("data_acquisition/R/acquire_cmems.R")

    - name: Commit and Push Changes
      run: |
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"

        git add .
        
        if git diff --staged --quiet; then
          echo "No changes to commit."
        else
          git commit -m "Added new CMEMS file"
          git pull origin main --rebase
          git push origin main
        fi
