---
title: "Leatherback ROMS model"
toc: false
editor: 
  markdown: 
    wrap: 72
execute:
  echo: false    
---


The most recent map products from the model are shown below, in addition to an interactive map of the latest prediction.

```{r}
#| label: check-roms
#| warning: false
#| include: false

source("utils.R")

# Set today's date
get_date <- Sys.Date()

# Define dates of interest (related to 4-day lag from ROMS server)
dates <- get_date - 0:5

# ROMS status check
status <- sapply(dates, \(x) check_roms(x)) |> 
  any()

# Create badge based on result of ROMS status check
badge <- ifelse(status,
                "[![Static Badge](https://img.shields.io/badge/Status-Running-brightgreen?style=flat)](https://oceanmodeling.ucsc.edu/ccsnrt/)",
                "[![Static Badge](https://img.shields.io/badge/Status-Down-red?style=flat)](https://oceanmodeling.ucsc.edu/ccsnrt/)"
)
```


**Status of environmental products from ROMS:** `r paste0(badge)`


## Latest Map Products

```{r}
library(bslib)
library(htmltools)

bs_theme_dependencies(bs_theme(preset = "bootstrap")) |>
  lapply(function(x) {
    if (x$name == "bootstrap") {
      x$name <- "bootstrap-from-bslib"
    }
    x
  }) |>
  htmltools::tagList()


navset_card_tab(
  nav_panel(title = "Latest", img(src = "https://github.com/joshcullen/CEG_operationalization/blob/main/model_prediction/ROMS/img/leatherbackTurtle_2024-11-24.png?raw=true", width = "50%")),
  nav_panel(title = "Latest - 1", img(src = "https://github.com/joshcullen/CEG_operationalization/blob/main/model_prediction/ROMS/img/leatherbackTurtle_2024-11-08.png?raw=true", width = "50%")),
  nav_panel(title = "Latest - 2", p("Add content"))
)
```


## Interactive Map

This example only shows prediction for 2024-11-24, but we could potentially make some adjustments to allow selection of one of dates shown above (or more).

```{r}
#| column: body

library(leaflet)
library(leafem)
library(terra)
library(cmocean)


### Read in raster layers for latest date

# Model prediction
r <- rast("https://raw.githubusercontent.com/joshcullen/CEG_operationalization/refs/heads/main/model_prediction/ROMS/rasters/pred_2024-11-24_leatherbackTurtle.tiff")

# Environmental predictors
eke <- rast("https://raw.githubusercontent.com/joshcullen/CEG_operationalization/refs/heads/main/data_processing/ROMS/rasters/EKE_2024-11-24.tiff")
bv <- rast("https://raw.githubusercontent.com/joshcullen/CEG_operationalization/refs/heads/main/data_processing/ROMS/rasters/bv_2024-11-24.tiff")
curl <- rast("https://raw.githubusercontent.com/joshcullen/CEG_operationalization/refs/heads/main/data_processing/ROMS/rasters/curl_2024-11-24.tiff")
ild <- rast("https://raw.githubusercontent.com/joshcullen/CEG_operationalization/refs/heads/main/data_processing/ROMS/rasters/ild_2024-11-24.tiff")
ssh <- rast("https://raw.githubusercontent.com/joshcullen/CEG_operationalization/refs/heads/main/data_processing/ROMS/rasters/ssh_2024-11-24.tiff")
ssh_sd <- rast("https://raw.githubusercontent.com/joshcullen/CEG_operationalization/refs/heads/main/data_processing/ROMS/rasters/ssh_sd_2024-11-24.tiff")
sst <- rast("https://raw.githubusercontent.com/joshcullen/CEG_operationalization/refs/heads/main/data_processing/ROMS/rasters/sst_2024-11-24.tiff")
sst_sd <- rast("https://raw.githubusercontent.com/joshcullen/CEG_operationalization/refs/heads/main/data_processing/ROMS/rasters/sst_sd_2024-11-24.tiff")


### Process rasters

# Merge all covars and crop to model extent
covars <- c(eke, bv, curl, ild, ssh, ssh_sd, sst, sst_sd)


# Define color palette for raster layer
pal <- colorNumeric("inferno", domain = values(r), na.color = "transparent")
eke.pal <- colorNumeric(cmocean("tempo")(256), domain = values(covars[[1]]), na.color = "transparent")
bv.pal <- colorNumeric(cmocean("deep")(256), domain = values(covars[[2]]), na.color = "transparent")
curl.pal <- colorNumeric(cmocean("curl")(256), domain = values(covars[[3]]), na.color = "transparent")
ild.pal <- colorNumeric(cmocean("dense")(256), domain = values(covars[[4]]), na.color = "transparent")
ssh.pal <- colorNumeric(cmocean("delta")(256), domain = values(covars[[5]]), na.color = "transparent")
ssh_sd.pal <- colorNumeric(cmocean("matter")(256), domain = values(covars[[6]]), na.color = "transparent")
sst.pal <- colorNumeric(cmocean("thermal")(256), domain = values(covars[[7]]), na.color = "transparent")
sst_sd.pal <- colorNumeric(cmocean("amp")(256), domain = values(covars[[8]]), na.color = "transparent")


navset_card_tab(
  nav_panel(title = "Model Prediction",
            card(full_screen = TRUE,
                 leaflet() |> 
                   addProviderTiles(provider = providers$CartoDB.DarkMatter, group = "CartoDB",
                                    options = providerTileOptions(zIndex = -10)) |> 
                   addProviderTiles(provider = providers$Esri.WorldImagery, group = "Satellite",
                                    options = providerTileOptions(zIndex = -10)) |> 
                   addProviderTiles(provider = providers$Esri.OceanBasemap, group = "Bathymetry",
                                    options = providerTileOptions(zIndex = -10)) |> 
                   addLayersControl(position = "topright",
                                    baseGroups = c("CartoDB","Satellite","Bathymetry"),
                                    overlayGroups = "HSI",
                                    options = layersControlOptions(collapsed = TRUE, autoZIndex = FALSE)) |> 
                   addRasterImage(r, colors = pal, opacity = 0.8, group = "HSI", layerId = "HSI") |> 
                   addImageQuery(r, layerId = "HSI") |>  #add raster  query
                   addLegend(title = "Habitat Suitability", position = "bottomright", pal = pal, values = values(r))
            )
  ),
  
  nav_panel(title = "Environ. Predictors",
            card(full_screen = TRUE,
                 leaflet() |> 
                   addProviderTiles(provider = providers$CartoDB.DarkMatter, group = "CartoDB",
                                    options = providerTileOptions(zIndex = -10)) |> 
                   addProviderTiles(provider = providers$Esri.WorldImagery, group = "Satellite",
                                    options = providerTileOptions(zIndex = -10)) |> 
                   addProviderTiles(provider = providers$Esri.OceanBasemap, group = "Bathymetry",
                                    options = providerTileOptions(zIndex = -10)) |> 
                   addLayersControl(position = "topright",
                                    baseGroups = c("CartoDB","Satellite","Bathymetry"),
                                    overlayGroups = c("log(EKE)","BV","Curl","ILD","SSH","SSH_SD","SST","SST_SD"),
                                    options = layersControlOptions(collapsed = TRUE, autoZIndex = FALSE)) |> 
                   
                   addRasterImage(covars[[1]], colors = eke.pal, opacity = 1, group = "log(EKE)", layerId = "log(EKE)") |> 
                   addImageQuery(covars[[1]], layerId = "log(EKE)") |>  #add raster  query
                   addLegend(title = "log(EKE)", position = "bottomright", pal = eke.pal, values = values(covars[[1]]),
                             group = "log(EKE)") |> 
                   
                   addRasterImage(covars[[2]], colors = bv.pal, opacity = 1, group = "BV", layerId = "BV") |> 
                   addImageQuery(covars[[2]], layerId = "BV") |>  #add raster  query
                   addLegend(title = "BV", position = "bottomright", pal = bv.pal, values = values(covars[[2]]),
                             group = "BV") |> 
                   
                   addRasterImage(covars[[3]], colors = curl.pal, opacity = 1, group = "Curl",
                                  layerId = "Curl") |> 
                   addImageQuery(covars[[3]], layerId = "Curl") |>  #add raster  query
                   addLegend(title = "Curl", position = "bottomright", pal = curl.pal,
                             values = values(covars[[3]]), group = "Curl") |> 
                   
                   addRasterImage(covars[[4]], colors = ild.pal, opacity = 1, group = "ILD", layerId = "ILD") |> 
                   addImageQuery(covars[[4]], layerId = "ILD") |>  #add raster  query
                   addLegend(title = "ILD", position = "bottomright", pal = ild.pal, values = values(covars[[4]]),
                             group = "ILD") |> 
                   
                   addRasterImage(covars[[5]], colors = ssh.pal, opacity = 1, group = "SSH",
                                  layerId = "SSH") |> 
                   addImageQuery(covars[[5]], layerId = "SSH") |>  #add raster  query
                   addLegend(title = "SSH", position = "bottomright", pal = ssh.pal,
                             values = values(covars[[5]]), group = "SSH") |> 
                   
                   addRasterImage(covars[[6]], colors = ssh_sd.pal, opacity = 1, group = "SSH_SD",
                                  layerId = "SSH_SD") |> 
                   addImageQuery(covars[[6]], layerId = "SSH_SD") |>  #add raster  query
                   addLegend(title = "SSH_SD", position = "bottomright", pal = ssh_sd.pal,
                             values = values(covars[[6]]), group = "SSH_SD") |> 
                   
                   addRasterImage(covars[[7]], colors = sst.pal, opacity = 1, group = "SST", layerId = "SST") |> 
                   addImageQuery(covars[[7]], layerId = "SST") |>  #add raster  query
                   addLegend(title = "SST", position = "bottomright", pal = sst.pal, values = values(covars[[7]]),
                             group = "SST") |> 
                   
                   addRasterImage(covars[[8]], colors = sst_sd.pal, opacity = 1, group = "SST_SD",
                                  layerId = "SST_SD") |> 
                   addImageQuery(covars[[8]], layerId = "SST_SD") |>  #add raster  query
                   addLegend(title = "SST_SD", position = "bottomright", pal = sst_sd.pal,
                             values = values(covars[[8]]), group = "SST_SD") |> 
                   
                   hideGroup(c("BV","Curl","ILD","SSH","SSH_SD","SST","SST_SD"))
            )
  )
)
```

